name: Local DevSecOps Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  # Job 1: Environment Setup and Validation
  setup:
    name: Environment Setup
    runs-on: self-hosted  # This makes it run on your local runner
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Validate Environment
      run: |
        echo "=== Environment Information ==="
        echo "Hostname: $(hostname)"
        echo "User: $(whoami)"
        echo "Working Directory: $(pwd)"
        echo "Python Version: $(python3 --version)"
        echo "Docker Version: $(docker --version)"
        echo "Docker Scout Version: $(docker-scout version)"
        echo "Available Disk Space:"
        df -h
        echo "Available Memory:"
        free -h

  # Job 2: SAST Scanning with Bandit
  sast-scan:
    name: SAST Security Scan
    runs-on: self-hosted
    needs: setup
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python Environment
      run: |
        python3 -m venv venv
        source venv/bin/activate
        python -m pip install --upgrade pip
        pip install bandit[toml] safety
        
    - name: Install Application Dependencies
      run: |
        source venv/bin/activate
        if [ -f requirements.txt ]; then 
          pip install -r requirements.txt
        fi
        
    - name: Create Bandit Configuration
      run: |
        cat > bandit.yaml << EOF
        # Bandit configuration for PyGoat
        tests: ['B101', 'B102', 'B103', 'B104', 'B105', 'B106', 'B107', 'B108', 'B110', 'B112', 'B201', 'B301', 'B302', 'B303', 'B304', 'B305', 'B306', 'B307', 'B308', 'B309', 'B310', 'B311', 'B312', 'B313', 'B314', 'B315', 'B316', 'B317', 'B318', 'B319', 'B320', 'B321', 'B322', 'B323', 'B324', 'B325', 'B401', 'B402', 'B403', 'B404', 'B405', 'B406', 'B407', 'B408', 'B409', 'B410', 'B411', 'B412', 'B413', 'B501', 'B502', 'B503', 'B504', 'B505', 'B506', 'B507', 'B601', 'B602', 'B603', 'B604', 'B605', 'B606', 'B607', 'B608', 'B609', 'B610', 'B611', 'B701', 'B702', 'B703']
        
        # Severity and confidence levels
        severity: ['medium', 'high']
        confidence: ['medium', 'high']
        
        # Exclude directories
        exclude_dirs: ['tests', 'venv', '.git', 'node_modules']
        
        # Skip specific tests if needed
        skips: ['B101']  # Skip assert_used test
        EOF
        
    - name: Run Bandit SAST Scan (Full)
      run: |
        source venv/bin/activate
        echo "=== RUNNING FULL BANDIT SCAN ==="
        bandit -r . -f json -o bandit-full-report.json || true
        bandit -r . -f txt -o bandit-full-report.txt || true
        bandit -r . -f csv -o bandit-full-report.csv || true        

    - name: Run Bandit SAST Scan (Filtered)
      run: |
        source venv/bin/activate
        echo "=== RUNNING FILTERED BANDIT SCAN ==="
        bandit -r . -c bandit.yaml -f json -o bandit-filtered-report.json || true
        bandit -r . -c bandit.yaml -f txt -o bandit-filtered-report.txt || true
        bandit -r . -c bandit.yaml -f csv -o bandit-filtered-report.txt || true
        
    - name: Display Bandit Results
      run: |
        echo "=== BANDIT SCAN RESULTS SUMMARY ==="
        echo "--- Full Scan Results ---"
        if [ -f bandit-full-report.txt ]; then
          cat bandit-full-report.txt
        else
          echo "No full scan results found"
        fi
        echo ""
        echo "--- Filtered Scan Results ---"
        if [ -f bandit-filtered-report.txt ]; then
          cat bandit-filtered-report.txt
        else
          echo "No filtered scan results found"
        fi
        
    - name: Archive Bandit Reports
      run: |
        mkdir -p reports/bandit
        mv bandit-*.* reports/bandit/ 2>/dev/null || true
        ls -la reports/bandit/
        
    - name: Upload Bandit Artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: bandit-security-reports
        path: reports/bandit/

  # Job 3: Docker Build and Security Scan
  docker-security:
    name: Docker Security Scan
    runs-on: self-hosted
    needs: [setup, sast-scan]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Inspect Project Structure
      run: |
        echo "=== PROJECT STRUCTURE ANALYSIS ==="
        echo "Current directory: $(pwd)"
        echo "Contents:"
        find . -name "manage.py" -type f
        find . -name "Dockerfile" -type f
        ls -la
        echo "=== End Structure Analysis ==="
        
    - name: Build Docker Image Locally
      run: |
        echo "=== BUILDING DOCKER IMAGE ==="
        IMAGE_NAME="local-pygoat"
        IMAGE_TAG="devsecops-$(date +%s)"
        
        # Build the image
        docker build -t ${IMAGE_NAME}:${IMAGE_TAG} .
        docker tag ${IMAGE_NAME}:${IMAGE_TAG} ${IMAGE_NAME}:latest
        
        # Save image info for later steps
        echo "IMAGE_NAME=${IMAGE_NAME}" >> $GITHUB_ENV
        echo "IMAGE_TAG=${IMAGE_TAG}" >> $GITHUB_ENV
        
        echo "Built image: ${IMAGE_NAME}:${IMAGE_TAG}"
        docker images | grep ${IMAGE_NAME}
        
    - name: Inspect Docker Image
      run: |
        echo "=== DOCKER IMAGE INSPECTION ==="
        echo "Image: ${IMAGE_NAME}:latest"
        
        # Inspect the filesystem structure inside the container
        echo "--- Container File Structure ---"
        docker run --rm ${IMAGE_NAME}:latest find / -name "manage.py" 2>/dev/null || echo "manage.py not found"
        docker run --rm ${IMAGE_NAME}:latest ls -la / 2>/dev/null || echo "Root directory listing failed"
        docker run --rm ${IMAGE_NAME}:latest ls -la /app 2>/dev/null || echo "/app directory not found"
        
        # Check the working directory
        echo "--- Working Directory ---"
        docker run --rm ${IMAGE_NAME}:latest pwd
        
        # Check what's in the working directory
        echo "--- Working Directory Contents ---"
        docker run --rm ${IMAGE_NAME}:latest ls -la
        
    - name: Docker Scout Quick View
      run: |
        echo "=== DOCKER SCOUT QUICKVIEW ==="
        docker-scout quickview ${IMAGE_NAME}:latest || echo "Quickview failed, continuing..."
        
    - name: Docker Scout CVE Analysis (Basic)
      run: |
        echo "=== DOCKER SCOUT CVE ANALYSIS ==="
        docker-scout cves ${IMAGE_NAME}:latest || echo "CVE analysis failed, continuing..."
        
    - name: Docker Scout CVE Analysis (Detailed)
      run: |
        echo "=== DOCKER SCOUT DETAILED CVE ANALYSIS ==="
        mkdir -p reports/docker-scout
        
        # Generate different report formats
        docker-scout cves ${IMAGE_NAME}:latest > reports/docker-scout/scout-cves-table.txt 2>&1 || true        
        
        # Filter for high/critical only
        docker-scout cves ${IMAGE_NAME}:latest 2>&1 | grep -E "(CRITICAL|HIGH)" > reports/docker-scout/scout-critical-high.txt || echo "No critical/high issues found or filtering not supported" > reports/docker-scout/scout-critical-high.txt
        
        echo "=== SCOUT REPORTS GENERATED ==="
        ls -la reports/docker-scout/
        
    - name: Display Docker Scout Results
      run: |
        echo "=== DOCKER SCOUT RESULTS SUMMARY ==="
        if [ -f reports/docker-scout/scout-critical-high.txt ]; then
          echo "--- Critical and High Severity Issues ---"
          cat reports/docker-scout/scout-critical-high.txt
        fi
        
        if [ -f reports/docker-scout/scout-cves-table.txt ]; then
          echo "--- All CVE Issues (First 50 lines) ---"
          head -50 reports/docker-scout/scout-cves-table.txt
        fi
        
    - name: Upload Docker Scout Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: docker-scout-reports
        path: reports/docker-scout/
        
    - name: Test Application Locally
      run: |
        echo "=== TESTING APPLICATION LOCALLY ==="
        
        # First, determine the correct command to run based on container inspection
        echo "--- Determining Application Start Command ---"
        
        # Try to find manage.py and determine the correct path
        MANAGE_PY_PATH=$(docker run --rm ${IMAGE_NAME}:latest find / -name "manage.py" -type f 2>/dev/null | head -1)
        
        if [ -n "$MANAGE_PY_PATH" ]; then
          echo "Found manage.py at: $MANAGE_PY_PATH"
          DJANGO_DIR=$(dirname "$MANAGE_PY_PATH")
          echo "Django directory: $DJANGO_DIR"
          
          # Start container with the correct path
          CONTAINER_ID=$(docker run -d -p 8000:8000 ${IMAGE_NAME}:latest sh -c "cd $DJANGO_DIR && python manage.py runserver 0.0.0.0:8000")
        else
          echo "manage.py not found, trying alternative startup methods..."
          
          # Check if there's a startup script or if we should use a different approach
          docker run --rm ${IMAGE_NAME}:latest ls -la /usr/local/bin/ | grep -E "(start|run|entry)" || echo "No obvious startup scripts"
          
          # Try with the image's default command or entrypoint
          echo "Starting with default container command..."
          CONTAINER_ID=$(docker run -d -p 8000:8000 ${IMAGE_NAME}:latest)
        fi
        
        echo "Started container: $CONTAINER_ID"
    
        # Wait for application to start
        sleep 15
    
        # Test if application is responding
        curl -f http://localhost:8000 || echo "Application health check failed - this may be expected for PyGoat"
    
        # Show container logs for debugging
        echo "=== Container Logs ==="
        docker logs $CONTAINER_ID
    
        # Stop the test container
        docker stop $CONTAINER_ID
        docker rm $CONTAINER_ID
    
        echo "Local testing completed"
 
  # Job 4: Security Report Analysis
  security-analysis:
    name: Security Analysis & Reporting
    runs-on: self-hosted
    needs: [sast-scan, docker-security]
    if: always()
    
    steps:
    - name: Download All Artifacts
      uses: actions/download-artifact@v4
      
    - name: Generate Security Summary Report
      run: |
        echo "=== GENERATING SECURITY SUMMARY REPORT ==="
        mkdir -p reports/summary
        
        cat > reports/summary/security-summary.md << 'EOF'
        # DevSecOps Security Analysis Report
        
        Generated on: $(date)
        Repository: $(git remote get-url origin)
        Commit: $(git rev-parse HEAD)
        
        ## SAST (Static Application Security Testing) Results
        
        ### Bandit Scan Summary
        - **Tool**: Bandit Python Security Scanner
        - **Scope**: Python source code analysis
        - **Configuration**: Custom severity and confidence filtering
        
        EOF
        
        # Add Bandit results if available
        if [ -f bandit-security-reports/bandit-filtered-report.txt ]; then
          echo "### Filtered Bandit Results" >> reports/summary/security-summary.md
          echo '```' >> reports/summary/security-summary.md
          cat bandit-security-reports/bandit-filtered-report.txt >> reports/summary/security-summary.md
          echo '```' >> reports/summary/security-summary.md
        fi
        
        # Add Docker Scout results if available
        cat >> reports/summary/security-summary.md << 'EOF'
        
        ## Container Security Results
        
        ### Docker Scout Analysis
        - **Tool**: Docker Scout CVE Scanner
        - **Scope**: Container image vulnerabilities
        - **Focus**: Critical and High severity issues
        
        EOF
        
        if [ -f docker-scout-reports/scout-critical-high.txt ]; then
          echo "### Critical and High Severity Issues" >> reports/summary/security-summary.md
          echo '```' >> reports/summary/security-summary.md
          cat docker-scout-reports/scout-critical-high.txt >> reports/summary/security-summary.md
          echo '```' >> reports/summary/security-summary.md
        fi
        
        # Display the summary
        cat reports/summary/security-summary.md
        
    - name: Upload Security Summary
      uses: actions/upload-artifact@v4
      with:
        name: security-summary-report
        path: reports/summary/

  # Job 5: Improved Local Deployment
  local-deploy:
    name: Local Deployment Test
    runs-on: self-hosted
    needs: [docker-security]
    if: github.ref == 'refs/heads/main'
    
    steps:
    - name: Deploy Application Locally
      run: |
        echo "=== DEPLOYING APPLICATION LOCALLY ==="
    
        # Stop any existing PyGoat containers
        docker stop pygoat-local 2>/dev/null || true
        docker rm pygoat-local 2>/dev/null || true
    
        # Determine the correct startup command
        echo "--- Determining Application Startup Command ---"
        
        # Try to find manage.py location
        MANAGE_PY_PATH=$(docker run --rm local-pygoat:latest find / -name "manage.py" -type f 2>/dev/null | head -1)
        
        if [ -n "$MANAGE_PY_PATH" ]; then
          echo "Found manage.py at: $MANAGE_PY_PATH"
          DJANGO_DIR=$(dirname "$MANAGE_PY_PATH")
          
          # Start container with Django development server
          docker run -d --name pygoat-local -p 8080:8000 local-pygoat:latest sh -c "cd $DJANGO_DIR && python manage.py runserver 0.0.0.0:8000"
        else
          echo "manage.py not found, checking for other startup options..."
          
          # Check if there's a predefined CMD or ENTRYPOINT
          docker inspect local-pygoat:latest | grep -A 5 -E "(Cmd|Entrypoint)" || echo "No specific command found"
          
          # Try to start with the default image configuration
          echo "Starting with default image configuration..."
          docker run -d --name pygoat-local -p 8080:8000 local-pygoat:latest
        fi
    
        # Wait for startup
        sleep 20
        
    - name: Verify Deployment
      run: |
        echo "=== VERIFYING DEPLOYMENT ==="
        
        # Check if container is running
        if docker ps | grep -q pygoat-local; then
          echo "✅ Container is running"
          
          # Test different endpoints
          echo "--- Testing Application Endpoints ---"
          
          # Test root endpoint
          if curl -s -o /dev/null -w "%{http_code}" http://localhost:8080 | grep -q "200\|302\|404"; then
            HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost:8080)
            echo "✅ Application responding with HTTP $HTTP_CODE at http://localhost:8080"
          else
            echo "❌ Application not responding at root endpoint"
          fi
          
          # Test if it's a Django application
          if curl -s http://localhost:8080 | grep -q -i "django\|pygoat"; then
            echo "✅ Django/PyGoat application detected"
          fi
          
        else
          echo "❌ Container is not running"
          docker ps -a | grep pygoat-local
        fi
        
    - name: Display Deployment Info
      run: |
        echo "=== DEPLOYMENT INFORMATION ==="
        echo "Application URL: http://localhost:8080"
        echo ""
        echo "Container Status:"
        docker ps | grep pygoat-local || echo "Container not running"
        echo ""
        echo "Container Logs (last 30 lines):"
        docker logs --tail 30 pygoat-local 2>&1 || echo "Could not retrieve logs"
        echo ""
        echo "Container Process List:"
        docker exec pygoat-local ps aux 2>/dev/null || echo "Could not retrieve process list"
        echo ""
        echo "Network Information:"
        docker port pygoat-local 2>/dev/null || echo "Could not retrieve port information"
